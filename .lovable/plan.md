

## Renewal Creates New Booking + Locker Refund Automation

### Overview
Three changes: (1) Renewals create a separate new booking record, (2) renewal bookings skip locker charges, (3) expired bookings with locker deposits auto-appear in the Deposits and Refunds page as "refund due."

---

### 1. Renewal Creates a New Booking Record

**Current behavior:** `BookingRenewal.tsx` uses `transactionService.createTransaction` which merely updates the existing booking's `total_price` -- no new row is created.

**New behavior:** On successful renewal payment, insert a NEW booking row in the `bookings` table with:
- Same `user_id`, `cabin_id`, `seat_id`, `seat_number`
- `start_date` = day after original booking's `end_date`
- `end_date` = calculated new end date
- `total_price` = renewal amount (seat price only, NO locker)
- `locker_included = false`, `locker_price = 0` (locker was already paid on original booking)
- `payment_status = 'completed'`
- `payment_method`, `razorpay_order_id`, `razorpay_payment_id` from payment response
- A new `serial_number` will be auto-generated by the existing DB trigger

**Files changed:**
- `src/components/booking/BookingRenewal.tsx` -- Rewrite `handlePaymentSuccess` to call `bookingsService.createBooking` (or a new `renewBooking` method) instead of `transactionService.processRenewal`. Remove the transaction-based flow and replace with direct booking creation after payment verification.
- `src/api/bookingsService.ts` -- Update `renewBooking` to accept locker fields and set `locker_included: false`, `locker_price: 0`.

**Receipt creation:** After the new booking is created, also insert a receipt row into the `receipts` table for the renewal payment (matching existing receipt creation patterns).

---

### 2. Locker Not Charged on Renewal

In the `BookingRenewal.tsx` Extension Summary UI:
- Do NOT add locker deposit to the renewal amount
- Show a note: "Locker deposit already paid on original booking"
- The `calculateAdditionalAmount()` already only uses seat price -- this is correct, no change needed there

In the new booking row created by renewal:
- `locker_included = false` (or carry forward the flag but with `locker_price = 0`)
- This ensures locker amount is not double-counted in collections or receipts

---

### 3. Auto-Show Locker Refund When Booking Expires

**Current behavior:** The Deposits and Refunds page (`DepositAndRestrictionManagement.tsx`) calls the backend MongoDB API for deposit data. Since bookings are now in Supabase, this needs a Supabase-based query.

**New approach:** Create a Supabase-based deposit/refund query service:
- Query `bookings` where `locker_included = true` AND `locker_price > 0` AND `payment_status IN ('completed', 'advance_paid')`
- For the "Refund Due" tab: filter where `end_date < today` (booking period ended) -- these automatically appear as refund-pending
- For the "Deposits" tab: show all bookings with locker deposits
- For the "Refunded" tab: filter where a refund has been processed

**Database changes needed:**
- Add columns to `bookings` table: `locker_refunded` (boolean, default false), `locker_refund_date` (timestamptz, nullable), `locker_refund_amount` (numeric, default 0), `locker_refund_method` (text, default ''), `locker_refund_transaction_id` (text, default '')
- These track whether the locker deposit has been refunded for each booking

**Files changed:**
- `src/api/depositRefundService.ts` -- Replace axios calls with Supabase queries that read from the `bookings` table joined with `profiles` and `cabins`. Map the data to the existing `DepositRefund` interface.
- `src/components/admin/DepositManagement.tsx` -- Update to use the new Supabase-based service. The "Deposits" tab shows all bookings with `locker_included = true`.
- `src/components/admin/RefundManagement.tsx` -- Update to use Supabase-based service:
  - "Refund Management" tab: bookings where `end_date < today` AND `locker_refunded = false` (auto-populated)
  - "Refunded" tab: bookings where `locker_refunded = true`
  - Process refund action updates `locker_refunded`, `locker_refund_date`, etc.

---

### Summary of Changes

| File | Change |
|------|--------|
| **Migration** | Add `locker_refunded`, `locker_refund_date`, `locker_refund_amount`, `locker_refund_method`, `locker_refund_transaction_id` columns to `bookings` table |
| `src/components/booking/BookingRenewal.tsx` | Create new booking on renewal instead of updating existing; skip locker charge; create receipt |
| `src/api/bookingsService.ts` | Update `renewBooking` to set `locker_included: false`, `locker_price: 0`, accept seat_id |
| `src/api/depositRefundService.ts` | Replace backend API calls with Supabase queries on `bookings` table for deposit/refund data |
| `src/components/admin/DepositManagement.tsx` | Use Supabase-based deposit queries |
| `src/components/admin/RefundManagement.tsx` | Use Supabase-based refund queries; auto-show expired bookings as refund-due |

### Key Business Logic
- Only the FIRST booking for a seat carries the locker deposit
- Renewed bookings reference the same seat but have `locker_price = 0`
- When ANY booking with `locker_included = true` expires (end_date < today), it automatically appears in the Refund Management tab
- Each booking is a separate record with its own serial number, making tracking clear for all stakeholders

