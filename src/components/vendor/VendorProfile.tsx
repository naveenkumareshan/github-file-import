import React, { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { useToast } from '@/hooks/use-toast';
import { 
  User, Building, MapPin, CreditCard, FileText, Phone, Mail,
  Calendar, CheckCircle, Clock, XCircle, AlertCircle, Upload, Trash2, FileIcon
} from 'lucide-react';
import { vendorProfileService, VendorProfileData, VendorProfileUpdateData } from '@/api/vendorProfileService';
import { supabase } from '@/integrations/supabase/client';

export const VendorProfile: React.FC = () => {
  const { toast } = useToast();
  const [profile, setProfile] = useState<VendorProfileData | null>(null);
  const [loading, setLoading] = useState(true);
  const [updating, setUpdating] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [formData, setFormData] = useState<VendorProfileUpdateData>({});
  const [documents, setDocuments] = useState<{ name: string; url: string }[]>([]);
  const [uploadingDoc, setUploadingDoc] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const hasFetched = useRef(false);

  useEffect(() => {
    if (!hasFetched.current) {
      hasFetched.current = true;
      fetchProfile();
      fetchDocuments();
    }
  }, []);

  const fetchProfile = async () => {
    try {
      const response = await vendorProfileService.getProfile();
      if (response.success && response.data) {
        const profileData = response.data as VendorProfileData;
        setProfile(profileData);
        setFormData({
          businessName: profileData.businessName,
          contactPerson: profileData.contactPerson,
          phone: profileData.phone,
          address: profileData.address,
          businessDetails: profileData.businessDetails,
          bankDetails: profileData.bankDetails
        });
      } else {
        toast({ title: "Error", description: response.error || "Failed to load profile", variant: "destructive" });
      }
    } catch {
      toast({ title: "Error", description: "Failed to load profile", variant: "destructive" });
    } finally {
      setLoading(false);
    }
  };

  const fetchDocuments = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data, error } = await supabase.storage
        .from('partner-documents')
        .list(user.id, { limit: 100 });
      if (error) throw error;
      const docs = (data || []).map(f => ({
        name: f.name,
        url: supabase.storage.from('partner-documents').getPublicUrl(`${user.id}/${f.name}`).data.publicUrl
      }));
      setDocuments(docs);
    } catch {
      // silent
    }
  };

  const handleDocUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    setUploadingDoc(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      for (const file of Array.from(files)) {
        const filePath = `${user.id}/${Date.now()}_${file.name}`;
        const { error } = await supabase.storage
          .from('partner-documents')
          .upload(filePath, file);
        if (error) throw error;
      }
      toast({ title: "Success", description: "Document(s) uploaded" });
      fetchDocuments();
    } catch (err: any) {
      toast({ title: "Error", description: err.message || "Upload failed", variant: "destructive" });
    } finally {
      setUploadingDoc(false);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  const handleDocDelete = async (docName: string) => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { error } = await supabase.storage
        .from('partner-documents')
        .remove([`${user.id}/${docName}`]);
      if (error) throw error;
      toast({ title: "Deleted", description: "Document removed" });
      fetchDocuments();
    } catch {
      toast({ title: "Error", description: "Failed to delete", variant: "destructive" });
    }
  };

  const handleUpdate = async () => {
    setUpdating(true);
    try {
      const response = await vendorProfileService.updateProfile(formData);
      if (response.success && response.data) {
        setProfile(response.data as VendorProfileData);
        setEditMode(false);
        toast({ title: "Success", description: "Profile updated successfully" });
      } else {
        toast({ title: "Error", description: "Failed to update profile", variant: "destructive" });
      }
    } catch {
      toast({ title: "Error", description: "Failed to update profile", variant: "destructive" });
    } finally {
      setUpdating(false);
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'approved':
        return <Badge className="bg-green-100 text-green-800"><CheckCircle className="w-3 h-3 mr-1" />Approved</Badge>;
      case 'pending':
        return <Badge className="bg-yellow-100 text-yellow-800"><Clock className="w-3 h-3 mr-1" />Pending</Badge>;
      case 'rejected':
        return <Badge className="bg-red-100 text-red-800"><XCircle className="w-3 h-3 mr-1" />Rejected</Badge>;
      case 'suspended':
        return <Badge className="bg-orange-100 text-orange-800"><AlertCircle className="w-3 h-3 mr-1" />Suspended</Badge>;
      default:
        return <Badge variant="secondary">{status}</Badge>;
    }
  };

  if (loading) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center p-8">
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4" />
            <p className="text-sm">Loading profile...</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (!profile) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center p-8">
          <div className="text-center">
            <AlertCircle className="h-8 w-8 text-muted-foreground mx-auto mb-2" />
            <p className="text-sm font-medium">Profile not found</p>
            <p className="text-xs text-muted-foreground mt-1">Your partner profile has not been set up yet. Please contact the admin.</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <Card>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-primary/10 rounded-full">
                <Building className="h-5 w-5 text-primary" />
              </div>
              <div>
                <CardTitle className="text-lg">{profile.businessName || 'Partner'}</CardTitle>
                <p className="text-xs text-muted-foreground">ID: {profile.vendorId}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {getStatusBadge(profile.status)}
              {!editMode && (
                <Button size="sm" variant="outline" className="h-7 text-xs" onClick={() => setEditMode(true)}>Edit</Button>
              )}
            </div>
          </div>
        </CardHeader>
      </Card>

      <Tabs defaultValue="basic" className="space-y-3">
        <TabsList className="h-8">
          <TabsTrigger value="basic" className="text-xs">Basic Info</TabsTrigger>
          <TabsTrigger value="business" className="text-xs">Business Details</TabsTrigger>
          <TabsTrigger value="bank" className="text-xs">Bank Details</TabsTrigger>
          <TabsTrigger value="documents" className="text-xs">Documents</TabsTrigger>
        </TabsList>

        <TabsContent value="basic" className="space-y-3">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm flex items-center gap-2"><User className="h-4 w-4" />Basic Information</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <Label className="text-xs">Business Name</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.businessName || ''} onChange={(e) => setFormData({...formData, businessName: e.target.value})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.businessName || '—'}</p>
                  )}
                </div>
                <div>
                  <Label className="text-xs">Contact Person</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.contactPerson || ''} onChange={(e) => setFormData({...formData, contactPerson: e.target.value})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.contactPerson || '—'}</p>
                  )}
                </div>
                <div>
                  <Label className="text-xs flex items-center gap-1"><Mail className="h-3 w-3" />Email</Label>
                  <p className="mt-0.5 text-sm text-muted-foreground">{profile.email}</p>
                </div>
                <div>
                  <Label className="text-xs flex items-center gap-1"><Phone className="h-3 w-3" />Phone</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.phone || ''} onChange={(e) => setFormData({...formData, phone: e.target.value})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.phone || '—'}</p>
                  )}
                </div>
              </div>

              <div>
                <Label className="text-xs flex items-center gap-1"><MapPin className="h-3 w-3" />Address</Label>
                {editMode ? (
                  <div className="mt-1 space-y-2">
                    <Input className="h-8 text-xs" placeholder="Street" value={formData.address?.street || ''} onChange={(e) => setFormData({...formData, address: {...formData.address, street: e.target.value}})} />
                    <div className="grid grid-cols-2 gap-2">
                      <Input className="h-8 text-xs" placeholder="City" value={formData.address?.city || ''} onChange={(e) => setFormData({...formData, address: {...formData.address, city: e.target.value}})} />
                      <Input className="h-8 text-xs" placeholder="State" value={formData.address?.state || ''} onChange={(e) => setFormData({...formData, address: {...formData.address, state: e.target.value}})} />
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <Input className="h-8 text-xs" placeholder="Pincode" value={formData.address?.pincode || ''} onChange={(e) => setFormData({...formData, address: {...formData.address, pincode: e.target.value}})} />
                      <Input className="h-8 text-xs" placeholder="Country" value={formData.address?.country || ''} onChange={(e) => setFormData({...formData, address: {...formData.address, country: e.target.value}})} />
                    </div>
                  </div>
                ) : (
                  <div className="mt-0.5 text-sm">
                    <p>{profile.address?.street || '—'}</p>
                    <p className="text-muted-foreground">{profile.address?.city}, {profile.address?.state} {profile.address?.pincode}</p>
                  </div>
                )}
              </div>

              <div className="flex items-center gap-1.5 text-[11px] text-muted-foreground">
                <Calendar className="h-3 w-3" />
                Joined on {new Date(profile.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
              </div>

              {editMode && (
                <div className="flex gap-2 pt-2 border-t">
                  <Button size="sm" className="h-7 text-xs" onClick={handleUpdate} disabled={updating}>
                    {updating ? 'Saving...' : 'Save Changes'}
                  </Button>
                  <Button size="sm" variant="outline" className="h-7 text-xs" onClick={() => setEditMode(false)}>Cancel</Button>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="business" className="space-y-3">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm flex items-center gap-2"><FileText className="h-4 w-4" />Business Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <Label className="text-xs">Business Type</Label>
                  <p className="mt-0.5 text-sm font-medium capitalize">{profile.businessType || '—'}</p>
                </div>
                <div>
                  <Label className="text-xs">GST Number</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.businessDetails?.gstNumber || ''} onChange={(e) => setFormData({...formData, businessDetails: {...formData.businessDetails, gstNumber: e.target.value}})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.businessDetails?.gstNumber || 'Not provided'}</p>
                  )}
                </div>
                <div>
                  <Label className="text-xs">PAN Number</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.businessDetails?.panNumber || ''} onChange={(e) => setFormData({...formData, businessDetails: {...formData.businessDetails, panNumber: e.target.value}})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.businessDetails?.panNumber || 'Not provided'}</p>
                  )}
                </div>
                <div>
                  <Label className="text-xs">Aadhar Number</Label>
                  {editMode ? (
                    <Input className="h-8 text-xs" value={formData.businessDetails?.aadharNumber || ''} onChange={(e) => setFormData({...formData, businessDetails: {...formData.businessDetails, aadharNumber: e.target.value}})} />
                  ) : (
                    <p className="mt-0.5 text-sm font-medium">{profile.businessDetails?.aadharNumber || 'Not provided'}</p>
                  )}
                </div>
              </div>
              <div>
                <Label className="text-xs">Business Description</Label>
                {editMode ? (
                  <Textarea className="text-xs min-h-[60px]" value={formData.businessDetails?.description || ''} onChange={(e) => setFormData({...formData, businessDetails: {...formData.businessDetails, description: e.target.value}})} />
                ) : (
                  <p className="mt-0.5 text-sm">{profile.businessDetails?.description || 'No description'}</p>
                )}
              </div>
              {editMode && (
                <div className="flex gap-2 pt-2 border-t">
                  <Button size="sm" className="h-7 text-xs" onClick={handleUpdate} disabled={updating}>{updating ? 'Saving...' : 'Save'}</Button>
                  <Button size="sm" variant="outline" className="h-7 text-xs" onClick={() => setEditMode(false)}>Cancel</Button>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="bank" className="space-y-3">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm flex items-center gap-2"><CreditCard className="h-4 w-4" />Bank Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {[
                  { key: 'accountHolderName', label: 'Account Holder Name' },
                  { key: 'accountNumber', label: 'Account Number' },
                  { key: 'bankName', label: 'Bank Name' },
                  { key: 'ifscCode', label: 'IFSC Code' },
                  { key: 'upiId', label: 'UPI ID' },
                ].map(({ key, label }) => (
                  <div key={key}>
                    <Label className="text-xs">{label}</Label>
                    {editMode ? (
                      <Input className="h-8 text-xs" value={(formData.bankDetails as any)?.[key] || ''} onChange={(e) => setFormData({...formData, bankDetails: {...formData.bankDetails, [key]: e.target.value}})} />
                    ) : (
                      <p className="mt-0.5 text-sm font-medium">
                        {key === 'accountNumber' && (profile.bankDetails as any)?.[key]
                          ? `****${(profile.bankDetails as any)[key].slice(-4)}`
                          : (profile.bankDetails as any)?.[key] || 'Not provided'}
                      </p>
                    )}
                  </div>
                ))}
              </div>
              {editMode && (
                <div className="flex gap-2 pt-2 border-t">
                  <Button size="sm" className="h-7 text-xs" onClick={handleUpdate} disabled={updating}>{updating ? 'Saving...' : 'Save'}</Button>
                  <Button size="sm" variant="outline" className="h-7 text-xs" onClick={() => setEditMode(false)}>Cancel</Button>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="documents" className="space-y-3">
          <Card>
            <CardHeader className="pb-2">
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm flex items-center gap-2"><FileText className="h-4 w-4" />Business Documents</CardTitle>
                <Button size="sm" variant="outline" className="h-7 text-xs" onClick={() => fileInputRef.current?.click()} disabled={uploadingDoc}>
                  <Upload className="h-3 w-3 mr-1" />
                  {uploadingDoc ? 'Uploading...' : 'Upload'}
                </Button>
                <input ref={fileInputRef} type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" className="hidden" onChange={handleDocUpload} />
              </div>
            </CardHeader>
            <CardContent>
              <p className="text-[10px] text-muted-foreground mb-3">
                Upload business documents: Aadhar, PAN, GST Certificate, Cancelled Cheque, Site Photos, etc.
              </p>
              {documents.length === 0 ? (
                <div className="text-center py-8">
                  <FileIcon className="h-8 w-8 mx-auto text-muted-foreground/40 mb-2" />
                  <p className="text-xs text-muted-foreground">No documents uploaded yet</p>
                </div>
              ) : (
                <div className="space-y-1.5">
                  {documents.map((doc) => (
                    <div key={doc.name} className="flex items-center justify-between py-1.5 px-2.5 bg-muted/30 rounded text-xs">
                      <a href={doc.url} target="_blank" rel="noopener noreferrer" className="text-primary hover:underline truncate flex-1">
                        {doc.name}
                      </a>
                      <Button variant="ghost" size="sm" className="h-5 w-5 p-0 text-destructive hover:text-destructive ml-2" onClick={() => handleDocDelete(doc.name)}>
                        <Trash2 className="h-3 w-3" />
                      </Button>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
};
